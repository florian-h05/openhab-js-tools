<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>rules/alerting.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="itemutils.html">itemutils</a><ul class='methods'><li data-type='method'><a href="itemutils.html#.dimmer">dimmer</a></li><li data-type='method'><a href="itemutils.html#.getGroup">getGroup</a></li><li data-type='method'><a href="itemutils.html#.getRoofwindowOpenLevel">getRoofwindowOpenLevel</a></li></ul></li><li><a href="rulesx.html">rulesx</a><ul class='methods'><li data-type='method'><a href="rulesx.html#.getClockRule">getClockRule</a></li><li data-type='method'><a href="rulesx.html#.getAlarmClock">getAlarmClock</a></li><li data-type='method'><a href="rulesx.html#.getRainalarmRule">getRainalarmRule</a></li><li data-type='method'><a href="rulesx.html#.getSceneEngine">getSceneEngine</a></li></ul></li></ul><h3>Classes</h3><ul><li><a href="itemutils.GroupUtils.html">GroupUtils</a><ul class='methods'><li data-type='method'><a href="itemutils.GroupUtils.html#membersCount">membersCount</a></li><li data-type='method'><a href="itemutils.GroupUtils.html#descendentsCount">descendentsCount</a></li></ul></li><li><a href="rulesx%250AIssues%2520a%2520rainalarm%2520notification%2520if%2520the%2520given%2520window_door%2520is%2520open%2520(and%2520windspeed%2520is%2520high%2520enough).Rainalarm.html">Rainalarm</a></li><li><a href="rulesx.SceneEngine.html">SceneEngine</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">rules/alerting.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Copyright (c) 2022 Florian Hotze
 *
 * This program and the accompanying materials are made available under the
 * terms of the Eclipse Public License 2.0 which is available at
 * http://www.eclipse.org/legal/epl-2.0
 *
 * SPDX-License-Identifier: EPL-2.0
 */

const { actions, rules, items, triggers } = require('openhab');
const { getRoofwindowOpenLevel } = require('../itemutils');

/**
 * @typedef {Object} rainalarmConfig configuration for rainalarm
 * @memberof rulesx
 * @property {String} rainalarmItemName name of the rainalarm Item
 * @property {String} windspeedItemName bame of the windspeed Item-
 * @property {String} contactGroupName name of the contact group to monitor
 * @property {String[]} ignoreList list of contact Item names to ignore
 * @property {String} roofwindowTag tag that all roofwindow contacts have for identification
 * @property {Number} windspeedKlLueftung windspeed threshold for an alarm on "kleine Lüftung"
 * @property {Number} windspeedGrLueftung windspeed threshold for an alarm on "große Lüftung"
 */

/**
 * Rainalarm
 *
 * @memberof rulesx
 * Issues a rainalarm notification if the given window/door is open (and windspeed is high enough).
 */
class Rainalarm {
  /**
   * Constructor to create an instance. Do not call directly, instead call {@link rulesx.getRainalarmRule}.
   * @param {rulesx.rainalarmConfig} config rainalarm configuration
   * @hideconstructor
   */
  constructor (config) {
    if (typeof config.ignoreList !== 'object' || config.ignoreList === null) {
      throw Error('contactGroupName is not supplied or is not Array!');
    }
    if (typeof config.roofwindowTag !== 'string') {
      throw Error('roofwindowTag is not supplied or is not string!');
    }
    this.config = config;
  }

  /**
 * Sends a rainalarm notification for a roowindow.
 * @private
 * @param {String} baseItemName base of the Items names, e.g. Florian_Dachfenster
 * @param {Number} windspeed current windspeed
 */
  alarmRoofwindow (baseItemName, windspeed) {
    console.info(`Checking rainalarm for roofwindow ${baseItemName} ...`);
    const state = getRoofwindowOpenLevel(baseItemName);
    const label = items.getItem(baseItemName + '_zu').label;
    switch (state.int) {
      case 1: // kleine Lüftung
        if (windspeed >= this.config.windspeedKlLueftung) actions.NotificationAction.sendBroadcastNotification(`Achtung! Regenalarm: ${label} kleine Lüftung!`);
        break;
      case 2: // große Lüftung
        if (windspeed >= this.config.windspeedGrLueftung) actions.NotificationAction.sendBroadcastNotification(`Achtung! Regenalarm: ${label} große Lüftung!`);
        break;
      case 4:
        actions.NotificationAction.sendBroadcastNotification(`Achtung! Regenalarm: ${label} geöffnet!`);
        break;
      default:
        break;
    }
  }

  /**
 * Send a rainalarm notification for a single contact.
 * @private
 * @param {String} contactItem name of the contact Item.
 */
  alarmSingleContact (contactItem) {
    console.info(`Checking rainalarm for single contact ${contactItem} ...`);
    if (contactItem.state === 'OPEN') actions.NotificationAction.sendBroadcastNotification(`Achtung! Regenalarm: ${contactItem.label} geöffnet!`);
  }

  /**
 * Calls the appropiate function depending on the type of window/door.
 * @private
 * @param {String} itemname name of the Item
 * @param {Number} windspeed current windspeed
 */
  checkAlarm (itemname, windspeed) {
    if (!this.config.ignoreList.includes(itemname)) {
      const tags = items.getItem(itemname).tags;
      if (tags.includes(this.config.roofwindowTag)) {
        this.alarmRoofwindow(itemname.replace('_zu', '').replace('_klLueftung', '').replace('_grLueftung', ''), windspeed);
      } else {
        this.alarmSingleContact(itemname);
      }
    }
  }
}

/**
 * Returns the rainalarm rule.
 * @memberof rulesx
 * @param {rulesx.rainalarmConfig} config rainalarm configuration
 * @returns {HostRule}
 */
const getRainalarmRule = (config) => {
  return rules.JSRule({
    name: 'Rainalarm',
    description: 'Sends a broadcast notification when a window is open when it rains.',
    triggers: [
      triggers.ItemStateChangeTrigger(config.rainalarmItemName, 'CLOSED', 'OPEN'),
      triggers.GroupStateChangeTrigger(config.contactGroupName, 'CLOSED', 'OPEN')
    ],
    execute: (event) => {
      const windspeed = parseFloat(items.getItem(config.windspeedItemName).state);
      const RainalarmImpl = new Rainalarm(config);
      if (event.itemName === config.rainalarmItemName) {
        console.info('Rainalarm rule is running on alarm.');
        const groupMembers = items.getItem(config.contactGroupName).members.map((item) => item.name);
        for (const i in groupMembers) {
          RainalarmImpl.checkAlarm(groupMembers[i], windspeed);
        }
      } else if (event.itemName !== null) {
        if (items.getItem(config.rainalarmItemName).state === 'CLOSED') return;
        console.info(`Rainalarm rule is running on change, Item ${event.itemName}.`);
        const timeoutFunc = function (itemname, windspeed, config) {
          return () => {
            RainalarmImpl.checkAlarm(itemname, windspeed);
          };
        };
        setTimeout(timeoutFunc(event.itemName, windspeed, config), 2000);
      }
    },
    id: `rainalarm-for-${config.rainalarmItemName}`,
    tags: ['@hotzware/openhab-tools', 'getRainalarmRule', 'Alerting']
  });
};

module.exports = {
  getRainalarmRule
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.10</a> on Wed Jun 08 2022 11:09:28 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
